<%# Profile - Edit profile page %>

<div class="edit-profile-container">
  <div class="edit-profile-header">
    <h1>Edit Profile</h1>
    <p class="text-muted">Update your personal information and settings</p>
  </div>

  <form action="/profile/edit" method="POST" enctype="multipart/form-data" class="edit-profile-form">
    <div class="form-grid">
      <!-- Left Column - Main Info -->
      <div class="form-column">
        <!-- Avatar Section -->
        <div class="form-section">
          <h2 class="section-heading">Profile Photo</h2>
          <div class="avatar-upload">
            <div class="avatar avatar-xl" id="avatar-preview">
              <% if (user.avatar) { %>
                <img src="<%= user.avatar %>" alt="Current avatar" id="avatar-img">
              <% } else { %>
                <span id="avatar-initials"><%= user.firstName.charAt(0) %><%= user.lastName.charAt(0) %></span>
              <% } %>
            </div>
            <div class="avatar-actions">
              <label for="avatar" class="btn btn-outline">
                <i data-lucide="upload"></i>
                Upload New Photo
              </label>
              <input 
                type="file" 
                id="avatar" 
                name="avatar" 
                accept="image/*" 
                class="sr-only"
                onchange="previewAvatar(this)"
              >
              <p class="text-sm text-muted">JPG, PNG or GIF. Max 2MB.</p>
            </div>
          </div>
        </div>

        <!-- Basic Info -->
        <div class="form-section">
          <h2 class="section-heading">Basic Information</h2>
          
          <div class="form-row">
            <div class="form-group">
              <label for="firstName">First Name <span class="required">*</span></label>
              <input 
                type="text" 
                id="firstName" 
                name="firstName" 
                value="<%= user.firstName %>"
                required
                class="form-input"
              >
            </div>
            <div class="form-group">
              <label for="lastName">Last Name <span class="required">*</span></label>
              <input 
                type="text" 
                id="lastName" 
                name="lastName" 
                value="<%= user.lastName %>"
                required
                class="form-input"
              >
            </div>
          </div>

          <div class="form-group">
            <label for="username">Username <span class="required">*</span></label>
            <div class="input-with-prefix">
              <span class="input-prefix">@</span>
              <input 
                type="text" 
                id="username" 
                name="username" 
                value="<%= user.username %>"
                required
                pattern="[a-zA-Z0-9_]{3,30}"
                class="form-input"
              >
            </div>
            <span class="form-hint">Letters, numbers, and underscores only. 3-30 characters.</span>
          </div>

          <div class="form-group">
            <label for="email">Email <span class="required">*</span></label>
            <input 
              type="email" 
              id="email" 
              name="email" 
              value="<%= user.email %>"
              required
              class="form-input"
            >
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="grade">Grade</label>
              <select id="grade" name="grade" class="form-select">
                <option value="">Select Grade</option>
                <option value="9" <%= user.grade === 9 ? 'selected' : '' %>>9th Grade</option>
                <option value="10" <%= user.grade === 10 ? 'selected' : '' %>>10th Grade</option>
                <option value="11" <%= user.grade === 11 ? 'selected' : '' %>>11th Grade</option>
                <option value="12" <%= user.grade === 12 ? 'selected' : '' %>>12th Grade</option>
              </select>
            </div>
            <div class="form-group">
              <label for="school">School</label>
              <input 
                type="text" 
                id="school" 
                name="school" 
                value="<%= user.school || '' %>"
                class="form-input"
                placeholder="Your school name"
              >
            </div>
          </div>

          <div class="form-group">
            <label for="bio">Bio</label>
            <textarea 
              id="bio" 
              name="bio" 
              rows="4" 
              class="form-textarea"
              maxlength="500"
              placeholder="Tell others about yourself..."
            ><%= user.bio || '' %></textarea>
            <span class="char-counter" data-for="bio">0/500</span>
          </div>
        </div>

        <!-- Skills Section (for tutors) -->
        <% if (user.role === 'tutor' || user.role === 'admin') { %>
          <div class="form-section" id="skills">
            <h2 class="section-heading">Teaching Skills</h2>
            <p class="section-description">Add skills you can teach to other students.</p>
            
            <div class="skills-editor">
              <div id="skills-list" class="skills-list">
                <% if (user.skills && user.skills.length > 0) { %>
                  <% user.skills.forEach((skill, index) => { %>
                    <div class="skill-item" data-index="<%= index %>">
                      <div class="skill-item-header">
                        <input 
                          type="text" 
                          name="skills[<%= index %>][name]" 
                          value="<%= skill.name %>"
                          placeholder="Skill name"
                          class="form-input"
                          required
                        >
                        <select name="skills[<%= index %>][proficiency]" class="form-select">
                          <option value="beginner" <%= skill.proficiency === 'beginner' ? 'selected' : '' %>>Beginner</option>
                          <option value="intermediate" <%= skill.proficiency === 'intermediate' ? 'selected' : '' %>>Intermediate</option>
                          <option value="expert" <%= skill.proficiency === 'expert' ? 'selected' : '' %>>Expert</option>
                        </select>
                        <button type="button" class="btn btn-ghost btn-icon remove-skill" onclick="removeSkill(this)">
                          <i data-lucide="x"></i>
                        </button>
                      </div>
                      <textarea 
                        name="skills[<%= index %>][description]" 
                        placeholder="Describe your experience with this skill..."
                        class="form-textarea"
                        rows="2"
                      ><%= skill.description || '' %></textarea>
                    </div>
                  <% }) %>
                <% } %>
              </div>
              
              <button type="button" class="btn btn-outline" onclick="addSkill()">
                <i data-lucide="plus"></i>
                Add Skill
              </button>
            </div>
          </div>
        <% } %>

        <!-- Interests Section -->
        <div class="form-section">
          <h2 class="section-heading">Learning Interests</h2>
          <p class="section-description">What subjects are you interested in learning?</p>
          
          <div class="tags-input-container">
            <div id="interests-tags" class="tags-display">
              <% if (user.interests && user.interests.length > 0) { %>
                <% user.interests.forEach(interest => { %>
                  <span class="tag">
                    <%= interest %>
                    <button type="button" class="tag-remove" onclick="removeInterest(this, '<%= interest %>')">×</button>
                  </span>
                <% }) %>
              <% } %>
            </div>
            <input 
              type="text" 
              id="interest-input" 
              placeholder="Type an interest and press Enter"
              class="form-input"
              onkeydown="handleInterestKeydown(event)"
            >
            <input type="hidden" name="interests" id="interests-hidden" value="<%= user.interests ? user.interests.join(',') : '' %>">
          </div>
        </div>
      </div>

      <!-- Right Column - Additional Settings -->
      <div class="form-column">
        <!-- Social Links -->
        <div class="form-section">
          <h2 class="section-heading">Social Links</h2>
          <p class="section-description">Connect with other students outside SkillSwap.</p>
          
          <div class="form-group">
            <label for="discord">
              <i data-lucide="disc" class="icon-sm"></i>
              Discord
            </label>
            <input 
              type="text" 
              id="discord" 
              name="socialLinks[discord]" 
              value="<%= user.socialLinks?.discord || '' %>"
              class="form-input"
              placeholder="username#1234"
            >
          </div>

          <div class="form-group">
            <label for="instagram">
              <i data-lucide="instagram" class="icon-sm"></i>
              Instagram
            </label>
            <div class="input-with-prefix">
              <span class="input-prefix">@</span>
              <input 
                type="text" 
                id="instagram" 
                name="socialLinks[instagram]" 
                value="<%= user.socialLinks?.instagram || '' %>"
                class="form-input"
                placeholder="username"
              >
            </div>
          </div>

          <div class="form-group">
            <label for="linkedin">
              <i data-lucide="linkedin" class="icon-sm"></i>
              LinkedIn
            </label>
            <input 
              type="url" 
              id="linkedin" 
              name="socialLinks[linkedin]" 
              value="<%= user.socialLinks?.linkedin || '' %>"
              class="form-input"
              placeholder="https://linkedin.com/in/username"
            >
          </div>
        </div>

        <!-- Availability (for tutors) -->
        <% if (user.role === 'tutor' || user.role === 'admin') { %>
          <div class="form-section">
            <h2 class="section-heading">Availability</h2>
            <p class="section-description">Set your weekly tutoring schedule.</p>
            
            <div class="availability-editor">
              <% const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday']; %>
              <% days.forEach(day => { %>
                <div class="availability-day-row">
                  <label class="day-label">
                    <input 
                      type="checkbox" 
                      class="day-toggle"
                      <%= user.availability && user.availability[day] && user.availability[day].length > 0 ? 'checked' : '' %>
                      onchange="toggleDayAvailability(this, '<%= day %>')"
                    >
                    <span><%= day.charAt(0).toUpperCase() + day.slice(1) %></span>
                  </label>
                  <div class="time-slots" id="<%= day %>-slots">
                    <% if (user.availability && user.availability[day] && user.availability[day].length > 0) { %>
                      <% user.availability[day].forEach((slot, i) => { %>
                        <div class="time-slot">
                          <input type="time" name="availability[<%= day %>][<%= i %>][start]" value="<%= slot.start %>" class="form-input">
                          <span>to</span>
                          <input type="time" name="availability[<%= day %>][<%= i %>][end]" value="<%= slot.end %>" class="form-input">
                        </div>
                      <% }) %>
                    <% } else { %>
                      <span class="text-muted text-sm">Not available</span>
                    <% } %>
                  </div>
                </div>
              <% }) %>
            </div>
          </div>
        <% } %>

        <!-- Notification Preferences -->
        <div class="form-section">
          <h2 class="section-heading">Notifications</h2>
          
          <div class="checkbox-group">
            <label class="checkbox-label">
              <input 
                type="checkbox" 
                name="notifications[email]" 
                <%= user.notifications?.email !== false ? 'checked' : '' %>
              >
              <span>Email notifications</span>
            </label>
            <p class="checkbox-description">Receive email updates about sessions and messages</p>
          </div>

          <div class="checkbox-group">
            <label class="checkbox-label">
              <input 
                type="checkbox" 
                name="notifications[sessionReminders]" 
                <%= user.notifications?.sessionReminders !== false ? 'checked' : '' %>
              >
              <span>Session reminders</span>
            </label>
            <p class="checkbox-description">Get reminded before upcoming sessions</p>
          </div>

          <div class="checkbox-group">
            <label class="checkbox-label">
              <input 
                type="checkbox" 
                name="notifications[marketing]" 
                <%= user.notifications?.marketing ? 'checked' : '' %>
              >
              <span>Updates & tips</span>
            </label>
            <p class="checkbox-description">Occasional tips and platform updates</p>
          </div>
        </div>

        <!-- Privacy Settings -->
        <div class="form-section">
          <h2 class="section-heading">Privacy</h2>
          
          <div class="checkbox-group">
            <label class="checkbox-label">
              <input 
                type="checkbox" 
                name="privacy[showEmail]" 
                <%= user.privacy?.showEmail ? 'checked' : '' %>
              >
              <span>Show email on profile</span>
            </label>
          </div>

          <div class="checkbox-group">
            <label class="checkbox-label">
              <input 
                type="checkbox" 
                name="privacy[showSchool]" 
                <%= user.privacy?.showSchool !== false ? 'checked' : '' %>
              >
              <span>Show school on profile</span>
            </label>
          </div>

          <div class="checkbox-group">
            <label class="checkbox-label">
              <input 
                type="checkbox" 
                name="privacy[allowMessages]" 
                <%= user.privacy?.allowMessages !== false ? 'checked' : '' %>
              >
              <span>Allow messages from anyone</span>
            </label>
          </div>
        </div>

        <!-- Danger Zone -->
        <div class="form-section form-section-danger">
          <h2 class="section-heading">Danger Zone</h2>
          
          <div class="danger-action">
            <div>
              <h4>Change Password</h4>
              <p class="text-sm text-muted">Update your account password</p>
            </div>
            <a href="/profile/change-password" class="btn btn-outline">Change Password</a>
          </div>

          <div class="danger-action">
            <div>
              <h4>Delete Account</h4>
              <p class="text-sm text-muted">Permanently delete your account and all data</p>
            </div>
            <button type="button" class="btn btn-danger" onclick="confirmDeleteAccount()">Delete Account</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Form Actions -->
    <div class="form-actions">
      <a href="/profile/<%= user.username %>" class="btn btn-ghost">Cancel</a>
      <button type="submit" class="btn btn-primary">
        <i data-lucide="save"></i>
        Save Changes
      </button>
    </div>
  </form>
</div>

<style>
  .edit-profile-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: var(--space-6);
  }

  .edit-profile-header {
    margin-bottom: var(--space-8);
  }

  .edit-profile-header h1 {
    font-size: var(--text-3xl);
    margin-bottom: var(--space-2);
  }

  .form-grid {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: var(--space-8);
  }

  .form-section {
    background: var(--white);
    border-radius: var(--radius-lg);
    padding: var(--space-6);
    box-shadow: var(--shadow-sm);
    margin-bottom: var(--space-6);
  }

  .form-section-danger {
    border: 1px solid var(--danger-200);
  }

  .section-heading {
    font-size: var(--text-lg);
    margin-bottom: var(--space-2);
  }

  .section-description {
    color: var(--neutral-500);
    font-size: var(--text-sm);
    margin-bottom: var(--space-4);
  }

  .avatar-upload {
    display: flex;
    align-items: center;
    gap: var(--space-6);
  }

  .avatar-actions {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-4);
  }

  .form-group {
    margin-bottom: var(--space-4);
  }

  .form-group label {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    font-weight: 500;
    margin-bottom: var(--space-2);
  }

  .required {
    color: var(--danger-500);
  }

  .input-with-prefix {
    display: flex;
    align-items: center;
  }

  .input-prefix {
    padding: var(--space-3);
    background: var(--neutral-100);
    border: 1px solid var(--neutral-300);
    border-right: none;
    border-radius: var(--radius-md) 0 0 var(--radius-md);
    color: var(--neutral-500);
  }

  .input-with-prefix .form-input {
    border-radius: 0 var(--radius-md) var(--radius-md) 0;
  }

  .form-hint {
    font-size: var(--text-xs);
    color: var(--neutral-500);
    margin-top: var(--space-1);
    display: block;
  }

  .char-counter {
    font-size: var(--text-xs);
    color: var(--neutral-500);
    text-align: right;
    display: block;
    margin-top: var(--space-1);
  }

  .skills-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
    margin-bottom: var(--space-4);
  }

  .skill-item {
    background: var(--neutral-50);
    padding: var(--space-4);
    border-radius: var(--radius-md);
  }

  .skill-item-header {
    display: grid;
    grid-template-columns: 1fr 150px auto;
    gap: var(--space-3);
    margin-bottom: var(--space-3);
  }

  .btn-icon {
    padding: var(--space-2);
  }

  .tags-input-container {
    border: 1px solid var(--neutral-300);
    border-radius: var(--radius-md);
    padding: var(--space-3);
    background: var(--white);
  }

  .tags-display {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
    margin-bottom: var(--space-2);
  }

  .tag {
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-1) var(--space-2);
    background: var(--primary-100);
    color: var(--primary-700);
    border-radius: var(--radius-full);
    font-size: var(--text-sm);
  }

  .tag-remove {
    background: none;
    border: none;
    color: var(--primary-500);
    cursor: pointer;
    font-size: var(--text-lg);
    line-height: 1;
    padding: 0;
  }

  .tag-remove:hover {
    color: var(--danger-500);
  }

  .tags-input-container .form-input {
    border: none;
    padding: var(--space-2);
    width: 100%;
  }

  .tags-input-container .form-input:focus {
    outline: none;
    box-shadow: none;
  }

  .availability-editor {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  .availability-day-row {
    display: grid;
    grid-template-columns: 120px 1fr;
    gap: var(--space-4);
    align-items: start;
    padding: var(--space-2) 0;
    border-bottom: 1px solid var(--neutral-100);
  }

  .availability-day-row:last-child {
    border-bottom: none;
  }

  .day-label {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-weight: 500;
  }

  .time-slots {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
  }

  .time-slot {
    display: flex;
    align-items: center;
    gap: var(--space-2);
  }

  .time-slot .form-input {
    width: 110px;
    padding: var(--space-2);
    font-size: var(--text-sm);
  }

  .checkbox-group {
    margin-bottom: var(--space-4);
  }

  .checkbox-label {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    cursor: pointer;
  }

  .checkbox-label input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
  }

  .checkbox-description {
    font-size: var(--text-sm);
    color: var(--neutral-500);
    margin-left: 26px;
    margin-top: var(--space-1);
  }

  .danger-action {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-4) 0;
    border-bottom: 1px solid var(--neutral-100);
  }

  .danger-action:last-child {
    border-bottom: none;
    padding-bottom: 0;
  }

  .danger-action h4 {
    margin-bottom: var(--space-1);
  }

  .form-actions {
    display: flex;
    justify-content: flex-end;
    gap: var(--space-3);
    padding-top: var(--space-6);
    border-top: 1px solid var(--neutral-200);
    margin-top: var(--space-6);
  }

  @media (max-width: 1024px) {
    .form-grid {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 640px) {
    .edit-profile-container {
      padding: var(--space-4);
    }

    .form-row {
      grid-template-columns: 1fr;
    }

    .skill-item-header {
      grid-template-columns: 1fr;
    }

    .avatar-upload {
      flex-direction: column;
      text-align: center;
    }

    .availability-day-row {
      grid-template-columns: 1fr;
      gap: var(--space-2);
    }

    .danger-action {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-3);
    }
  }
</style>

<script>
  let skillCount = <%= user.skills ? user.skills.length : 0 %>;

  function previewAvatar(input) {
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const preview = document.getElementById('avatar-preview');
        const initials = document.getElementById('avatar-initials');
        let img = document.getElementById('avatar-img');
        
        if (!img) {
          img = document.createElement('img');
          img.id = 'avatar-img';
          preview.appendChild(img);
        }
        
        img.src = e.target.result;
        if (initials) initials.style.display = 'none';
      };
      reader.readAsDataURL(input.files[0]);
    }
  }

  function addSkill() {
    const skillsList = document.getElementById('skills-list');
    const skillItem = document.createElement('div');
    skillItem.className = 'skill-item';
    skillItem.dataset.index = skillCount;
    skillItem.innerHTML = `
      <div class="skill-item-header">
        <input type="text" name="skills[${skillCount}][name]" placeholder="Skill name" class="form-input" required>
        <select name="skills[${skillCount}][proficiency]" class="form-select">
          <option value="beginner">Beginner</option>
          <option value="intermediate">Intermediate</option>
          <option value="expert">Expert</option>
        </select>
        <button type="button" class="btn btn-ghost btn-icon remove-skill" onclick="removeSkill(this)">
          <i data-lucide="x"></i>
        </button>
      </div>
      <textarea name="skills[${skillCount}][description]" placeholder="Describe your experience..." class="form-textarea" rows="2"></textarea>
    `;
    skillsList.appendChild(skillItem);
    skillCount++;
    lucide.createIcons();
  }

  function removeSkill(button) {
    const skillItem = button.closest('.skill-item');
    skillItem.remove();
  }

  function handleInterestKeydown(event) {
    if (event.key === 'Enter') {
      event.preventDefault();
      const input = event.target;
      const value = input.value.trim();
      
      if (value) {
        addInterest(value);
        input.value = '';
      }
    }
  }

  function addInterest(interest) {
    const tagsDisplay = document.getElementById('interests-tags');
    const hiddenInput = document.getElementById('interests-hidden');
    
    // Check if already exists
    const current = hiddenInput.value ? hiddenInput.value.split(',') : [];
    if (current.includes(interest)) return;
    
    // Add tag
    const tag = document.createElement('span');
    tag.className = 'tag';
    tag.innerHTML = `${interest}<button type="button" class="tag-remove" onclick="removeInterest(this, '${interest}')">×</button>`;
    tagsDisplay.appendChild(tag);
    
    // Update hidden input
    current.push(interest);
    hiddenInput.value = current.join(',');
  }

  function removeInterest(button, interest) {
    const hiddenInput = document.getElementById('interests-hidden');
    const current = hiddenInput.value.split(',').filter(i => i !== interest);
    hiddenInput.value = current.join(',');
    button.closest('.tag').remove();
  }

  function toggleDayAvailability(checkbox, day) {
    const slotsContainer = document.getElementById(`${day}-slots`);
    
    if (checkbox.checked) {
      slotsContainer.innerHTML = `
        <div class="time-slot">
          <input type="time" name="availability[${day}][0][start]" value="15:00" class="form-input">
          <span>to</span>
          <input type="time" name="availability[${day}][0][end]" value="18:00" class="form-input">
        </div>
      `;
    } else {
      slotsContainer.innerHTML = '<span class="text-muted text-sm">Not available</span>';
    }
  }

  function confirmDeleteAccount() {
    if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
      if (confirm('This will permanently delete all your data, sessions, reviews, and messages. Type "DELETE" to confirm.')) {
        const confirmation = prompt('Type DELETE to confirm:');
        if (confirmation === 'DELETE') {
          window.location.href = '/profile/delete';
        }
      }
    }
  }

  // Initialize character counters
  document.addEventListener('DOMContentLoaded', function() {
    const textareas = document.querySelectorAll('textarea[maxlength]');
    textareas.forEach(textarea => {
      const counter = document.querySelector(`[data-for="${textarea.id}"]`);
      if (counter) {
        const updateCounter = () => {
          counter.textContent = `${textarea.value.length}/${textarea.maxLength}`;
        };
        textarea.addEventListener('input', updateCounter);
        updateCounter();
      }
    });
  });
</script>
