<%# Admin Reviews Management - Moderate and manage all reviews %>

<div class="admin-layout">
  <%- include('../../partials/admin-sidebar', { active: 'reviews' }) %>

  <main class="admin-main">
    <header class="admin-header">
      <div>
        <h1 class="admin-title">Review Management</h1>
        <p class="admin-subtitle">Moderate user reviews and ratings</p>
      </div>
      <div class="admin-header-actions">
        <a href="/admin/reviews/export" class="btn btn-outline">
          <span>üì•</span> Export
        </a>
      </div>
    </header>

    <!-- Stats -->
    <div class="stats-grid stats-grid-4 mb-4">
      <div class="stat-card compact">
        <div class="stat-content">
          <div class="stat-value"><%= stats.total || 0 %></div>
          <div class="stat-label">Total Reviews</div>
        </div>
      </div>
      <div class="stat-card compact">
        <div class="stat-content">
          <div class="stat-value"><%= (stats.avgRating || 0).toFixed(1) %></div>
          <div class="stat-label">Avg Rating</div>
        </div>
      </div>
      <div class="stat-card compact warning">
        <div class="stat-content">
          <div class="stat-value"><%= stats.flagged || 0 %></div>
          <div class="stat-label">Flagged</div>
        </div>
      </div>
      <div class="stat-card compact">
        <div class="stat-content">
          <div class="stat-value"><%= stats.thisWeek || 0 %></div>
          <div class="stat-label">This Week</div>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
      <div class="card-body">
        <form action="/admin/reviews" method="GET" class="filter-form">
          <div class="filter-row">
            <div class="form-group">
              <label class="form-label">Search</label>
              <input type="text" name="search" class="form-input" placeholder="Search reviews..." value="<%= query.search || '' %>">
            </div>
            <div class="form-group">
              <label class="form-label">Rating</label>
              <select name="rating" class="form-select">
                <option value="">All Ratings</option>
                <option value="5" <%= query.rating === '5' ? 'selected' : '' %>>5 Stars</option>
                <option value="4" <%= query.rating === '4' ? 'selected' : '' %>>4 Stars</option>
                <option value="3" <%= query.rating === '3' ? 'selected' : '' %>>3 Stars</option>
                <option value="2" <%= query.rating === '2' ? 'selected' : '' %>>2 Stars</option>
                <option value="1" <%= query.rating === '1' ? 'selected' : '' %>>1 Star</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Status</label>
              <select name="status" class="form-select">
                <option value="">All</option>
                <option value="approved" <%= query.status === 'approved' ? 'selected' : '' %>>Approved</option>
                <option value="flagged" <%= query.status === 'flagged' ? 'selected' : '' %>>Flagged</option>
                <option value="hidden" <%= query.status === 'hidden' ? 'selected' : '' %>>Hidden</option>
              </select>
            </div>
            <div class="form-group filter-actions">
              <label class="form-label">&nbsp;</label>
              <div class="btn-group">
                <button type="submit" class="btn btn-primary">Filter</button>
                <a href="/admin/reviews" class="btn btn-ghost">Reset</a>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Reviews List -->
    <div class="reviews-list">
      <% if (reviews && reviews.length > 0) { %>
        <% reviews.forEach(review => { %>
          <div class="card review-card mb-3 <%= review.status === 'flagged' ? 'flagged' : '' %>">
            <div class="card-body">
              <div class="review-header">
                <div class="review-users">
                  <div class="user-cell">
                    <div class="avatar avatar-sm">
                      <% if (review.reviewer?.avatar) { %>
                        <img src="<%= review.reviewer.avatar %>" alt="">
                      <% } else { %>
                        <span><%= review.reviewer?.firstName?.charAt(0) || 'U' %></span>
                      <% } %>
                    </div>
                    <div>
                      <span class="user-name"><%= review.reviewer?.firstName %> <%= review.reviewer?.lastName %></span>
                      <span class="review-direction">reviewed</span>
                      <span class="user-name"><%= review.reviewee?.firstName %> <%= review.reviewee?.lastName %></span>
                    </div>
                  </div>
                </div>
                <div class="review-meta">
                  <div class="rating-display">
                    <% for (let i = 1; i <= 5; i++) { %>
                      <span class="star <%= i <= review.rating ? 'filled' : '' %>">‚òÖ</span>
                    <% } %>
                  </div>
                  <span class="review-date"><%= new Date(review.createdAt).toLocaleDateString() %></span>
                  <% if (review.status === 'flagged') { %>
                    <span class="badge badge-warning">Flagged</span>
                  <% } else if (review.status === 'hidden') { %>
                    <span class="badge badge-secondary">Hidden</span>
                  <% } %>
                </div>
              </div>
              
              <div class="review-content">
                <p><%= review.comment %></p>
              </div>
              
              <% if (review.session) { %>
                <div class="review-session">
                  <span class="skill-tag"><%= review.session.skill %></span>
                  <span class="session-date"><%= new Date(review.session.scheduledDate).toLocaleDateString() %></span>
                </div>
              <% } %>
              
              <div class="review-actions">
                <% if (review.status === 'flagged') { %>
                  <form action="/admin/reviews/<%= review._id %>/approve" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-success btn-sm">Approve</button>
                  </form>
                <% } %>
                <% if (review.status !== 'hidden') { %>
                  <form action="/admin/reviews/<%= review._id %>/hide" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-outline btn-sm">Hide</button>
                  </form>
                <% } else { %>
                  <form action="/admin/reviews/<%= review._id %>/show" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-outline btn-sm">Show</button>
                  </form>
                <% } %>
                <form action="/admin/reviews/<%= review._id %>/delete" method="POST" style="display: inline;">
                  <button type="submit" class="btn btn-ghost btn-sm text-error" onclick="return confirm('Delete this review?')">Delete</button>
                </form>
              </div>
            </div>
          </div>
        <% }); %>
      <% } else { %>
        <div class="card">
          <div class="card-body">
            <div class="empty-state">
              <span class="empty-icon">‚≠ê</span>
              <h3>No reviews found</h3>
              <p>Try adjusting your filters</p>
            </div>
          </div>
        </div>
      <% } %>
    </div>

    <!-- Pagination -->
    <% if (totalPages > 1) { %>
      <nav class="pagination-nav">
        <a href="?page=<%= Math.max(1, currentPage - 1) %>&<%= queryString %>" 
           class="pagination-btn <%= currentPage === 1 ? 'disabled' : '' %>">‚Üê Previous</a>
        <div class="pagination-pages">
          <% for (let i = 1; i <= totalPages; i++) { %>
            <% if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) { %>
              <a href="?page=<%= i %>&<%= queryString %>" class="pagination-page <%= i === currentPage ? 'active' : '' %>"><%= i %></a>
            <% } else if (i === currentPage - 3 || i === currentPage + 3) { %>
              <span class="pagination-ellipsis">...</span>
            <% } %>
          <% } %>
        </div>
        <a href="?page=<%= Math.min(totalPages, currentPage + 1) %>&<%= queryString %>" 
           class="pagination-btn <%= currentPage === totalPages ? 'disabled' : '' %>">Next ‚Üí</a>
      </nav>
    <% } %>
  </main>
</div>

<style>
  .stats-grid-4 {
    grid-template-columns: repeat(4, 1fr);
  }
  
  @media (max-width: 768px) {
    .stats-grid-4 {
      grid-template-columns: repeat(2, 1fr);
    }
  }
  
  .stat-card.compact {
    padding: 1rem;
  }
  
  .stat-card.compact.warning {
    border-left: 3px solid var(--warning-500);
  }
  
  .review-card.flagged {
    border-left: 3px solid var(--warning-500);
    background: var(--warning-50);
  }
  
  .review-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
    flex-wrap: wrap;
    gap: 1rem;
  }
  
  .review-users .user-cell {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  
  .review-direction {
    color: var(--neutral-500);
    margin: 0 0.25rem;
  }
  
  .review-meta {
    display: flex;
    align-items: center;
    gap: 1rem;
  }
  
  .rating-display {
    display: flex;
    gap: 0.125rem;
  }
  
  .star {
    color: var(--neutral-300);
    font-size: 1rem;
  }
  
  .star.filled {
    color: var(--warning-400);
  }
  
  .review-date {
    font-size: var(--text-sm);
    color: var(--neutral-500);
  }
  
  .review-content {
    margin-bottom: 1rem;
    color: var(--neutral-700);
  }
  
  .review-session {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--neutral-100);
  }
  
  .session-date {
    font-size: var(--text-sm);
    color: var(--neutral-500);
  }
  
  .review-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }
  
  .filter-row {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr auto;
    gap: 1rem;
    align-items: end;
  }
  
  @media (max-width: 768px) {
    .filter-row {
      grid-template-columns: 1fr;
    }
  }
</style>
