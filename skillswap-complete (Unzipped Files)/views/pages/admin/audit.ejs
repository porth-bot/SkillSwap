<%# Admin Audit Logs - Security and activity tracking %>

<div class="admin-layout">
  <%- include('../../partials/admin-sidebar', { active: 'audit' }) %>

  <main class="admin-main">
    <header class="admin-header">
      <div>
        <h1 class="admin-title">Audit Logs</h1>
        <p class="admin-subtitle">Security and activity tracking</p>
      </div>
      <div class="admin-header-actions">
        <a href="/admin/audit/export" class="btn btn-outline">
          <span>üì•</span> Export Logs
        </a>
      </div>
    </header>

    <!-- Filters -->
    <div class="card mb-4">
      <div class="card-body">
        <form action="/admin/audit" method="GET" class="filter-form">
          <div class="filter-row">
            <div class="form-group">
              <label class="form-label">Search</label>
              <input type="text" name="search" class="form-input" placeholder="User, action, or details..." value="<%= query.search || '' %>">
            </div>
            <div class="form-group">
              <label class="form-label">Action Type</label>
              <select name="action" class="form-select">
                <option value="">All Actions</option>
                <option value="login" <%= query.action === 'login' ? 'selected' : '' %>>Login</option>
                <option value="logout" <%= query.action === 'logout' ? 'selected' : '' %>>Logout</option>
                <option value="create" <%= query.action === 'create' ? 'selected' : '' %>>Create</option>
                <option value="update" <%= query.action === 'update' ? 'selected' : '' %>>Update</option>
                <option value="delete" <%= query.action === 'delete' ? 'selected' : '' %>>Delete</option>
                <option value="admin" <%= query.action === 'admin' ? 'selected' : '' %>>Admin Action</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Date Range</label>
              <select name="dateRange" class="form-select">
                <option value="">All Time</option>
                <option value="today" <%= query.dateRange === 'today' ? 'selected' : '' %>>Today</option>
                <option value="week" <%= query.dateRange === 'week' ? 'selected' : '' %>>This Week</option>
                <option value="month" <%= query.dateRange === 'month' ? 'selected' : '' %>>This Month</option>
              </select>
            </div>
            <div class="form-group filter-actions">
              <label class="form-label">&nbsp;</label>
              <div class="btn-group">
                <button type="submit" class="btn btn-primary">Filter</button>
                <a href="/admin/audit" class="btn btn-ghost">Reset</a>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Logs Table -->
    <div class="card">
      <div class="card-body p-0">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>User</th>
              <th>Action</th>
              <th>Resource</th>
              <th>Details</th>
              <th>IP Address</th>
            </tr>
          </thead>
          <tbody>
            <% if (logs && logs.length > 0) { %>
              <% logs.forEach(log => { %>
                <tr class="log-row <%= log.action === 'delete' || log.action === 'admin' ? 'highlighted' : '' %>">
                  <td>
                    <div class="timestamp">
                      <span class="date"><%= new Date(log.createdAt).toLocaleDateString() %></span>
                      <span class="time"><%= new Date(log.createdAt).toLocaleTimeString() %></span>
                    </div>
                  </td>
                  <td>
                    <% if (log.user) { %>
                      <div class="user-cell">
                        <div class="avatar avatar-xs">
                          <span><%= log.user.firstName?.charAt(0) || '?' %></span>
                        </div>
                        <span><%= log.user.firstName %> <%= log.user.lastName %></span>
                      </div>
                    <% } else { %>
                      <span class="text-muted">System</span>
                    <% } %>
                  </td>
                  <td>
                    <span class="action-badge action-<%= log.action %>">
                      <%= log.action %>
                    </span>
                  </td>
                  <td>
                    <span class="resource-type"><%= log.resourceType %></span>
                    <% if (log.resourceId) { %>
                      <span class="resource-id">#<%= log.resourceId.toString().slice(-6) %></span>
                    <% } %>
                  </td>
                  <td>
                    <span class="log-details" title="<%= log.details %>">
                      <%= log.details?.substring(0, 50) %><%= log.details?.length > 50 ? '...' : '' %>
                    </span>
                  </td>
                  <td>
                    <code class="ip-address"><%= log.ipAddress || 'N/A' %></code>
                  </td>
                </tr>
              <% }); %>
            <% } else { %>
              <tr>
                <td colspan="6">
                  <div class="empty-state">
                    <span class="empty-icon">üìã</span>
                    <h3>No logs found</h3>
                    <p>Activity logs will appear here</p>
                  </div>
                </td>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Pagination -->
    <% if (totalPages > 1) { %>
      <nav class="pagination-nav">
        <a href="?page=<%= Math.max(1, currentPage - 1) %>&<%= queryString %>" 
           class="pagination-btn <%= currentPage === 1 ? 'disabled' : '' %>">‚Üê Previous</a>
        <div class="pagination-pages">
          <% for (let i = 1; i <= totalPages; i++) { %>
            <% if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) { %>
              <a href="?page=<%= i %>&<%= queryString %>" class="pagination-page <%= i === currentPage ? 'active' : '' %>"><%= i %></a>
            <% } else if (i === currentPage - 3 || i === currentPage + 3) { %>
              <span class="pagination-ellipsis">...</span>
            <% } %>
          <% } %>
        </div>
        <a href="?page=<%= Math.min(totalPages, currentPage + 1) %>&<%= queryString %>" 
           class="pagination-btn <%= currentPage === totalPages ? 'disabled' : '' %>">Next ‚Üí</a>
      </nav>
    <% } %>

    <!-- Log Retention Info -->
    <div class="log-info mt-4">
      <p class="text-sm text-muted">
        <strong>Note:</strong> Audit logs are retained for 90 days. Older logs are archived automatically.
        For compliance exports, use the Export Logs feature above.
      </p>
    </div>
  </main>
</div>

<style>
  .filter-row {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr auto;
    gap: 1rem;
    align-items: end;
  }
  
  @media (max-width: 768px) {
    .filter-row {
      grid-template-columns: 1fr;
    }
  }
  
  .timestamp {
    display: flex;
    flex-direction: column;
    font-size: var(--text-sm);
  }
  
  .timestamp .date {
    font-weight: 500;
  }
  
  .timestamp .time {
    color: var(--neutral-500);
  }
  
  .avatar-xs {
    width: 24px;
    height: 24px;
    font-size: var(--text-xs);
  }
  
  .action-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    font-size: var(--text-xs);
    font-weight: 600;
    text-transform: uppercase;
  }
  
  .action-login {
    background: var(--success-100);
    color: var(--success-700);
  }
  
  .action-logout {
    background: var(--neutral-100);
    color: var(--neutral-700);
  }
  
  .action-create {
    background: var(--primary-100);
    color: var(--primary-700);
  }
  
  .action-update {
    background: var(--warning-100);
    color: var(--warning-700);
  }
  
  .action-delete {
    background: var(--error-100);
    color: var(--error-700);
  }
  
  .action-admin {
    background: var(--accent-100);
    color: var(--accent-700);
  }
  
  .resource-type {
    font-weight: 500;
    color: var(--neutral-700);
  }
  
  .resource-id {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--neutral-500);
    margin-left: 0.25rem;
  }
  
  .log-details {
    font-size: var(--text-sm);
    color: var(--neutral-600);
    cursor: help;
  }
  
  .ip-address {
    font-size: var(--text-xs);
    background: var(--neutral-100);
    padding: 0.125rem 0.375rem;
    border-radius: var(--radius-sm);
  }
  
  .log-row.highlighted {
    background: var(--warning-50);
  }
  
  .log-info {
    padding: 1rem;
    background: var(--neutral-50);
    border-radius: var(--radius-md);
  }
</style>
