<%# Admin Users Management - Full CRUD with filters and search %>

<div class="admin-layout">
  <!-- Admin Sidebar -->
  <%- include('../../partials/admin-sidebar', { active: 'users' }) %>

  <!-- Main Content -->
  <main class="admin-main">
    <header class="admin-header">
      <div>
        <h1 class="admin-title">User Management</h1>
        <p class="admin-subtitle">Manage all users, roles, and permissions</p>
      </div>
      <div class="admin-header-actions">
        <a href="/admin/users/export?format=csv" class="btn btn-outline">
          <span>üì•</span> Export CSV
        </a>
        <a href="/admin/users/new" class="btn btn-primary">
          <span>+</span> Add User
        </a>
      </div>
    </header>

    <!-- Filters -->
    <div class="card mb-4">
      <div class="card-body">
        <form action="/admin/users" method="GET" class="filter-form">
          <div class="filter-row">
            <div class="form-group">
              <label class="form-label">Search</label>
              <input type="text" name="search" class="form-input" placeholder="Name, email, or username..." value="<%= query.search || '' %>">
            </div>
            <div class="form-group">
              <label class="form-label">Role</label>
              <select name="role" class="form-select">
                <option value="">All Roles</option>
                <option value="student" <%= query.role === 'student' ? 'selected' : '' %>>Student</option>
                <option value="tutor" <%= query.role === 'tutor' ? 'selected' : '' %>>Tutor</option>
                <option value="admin" <%= query.role === 'admin' ? 'selected' : '' %>>Admin</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Status</label>
              <select name="status" class="form-select">
                <option value="">All Status</option>
                <option value="active" <%= query.status === 'active' ? 'selected' : '' %>>Active</option>
                <option value="inactive" <%= query.status === 'inactive' ? 'selected' : '' %>>Inactive</option>
                <option value="suspended" <%= query.status === 'suspended' ? 'selected' : '' %>>Suspended</option>
                <option value="pending" <%= query.status === 'pending' ? 'selected' : '' %>>Pending</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Sort By</label>
              <select name="sort" class="form-select">
                <option value="createdAt" <%= query.sort === 'createdAt' ? 'selected' : '' %>>Newest First</option>
                <option value="-createdAt" <%= query.sort === '-createdAt' ? 'selected' : '' %>>Oldest First</option>
                <option value="lastName" <%= query.sort === 'lastName' ? 'selected' : '' %>>Name A-Z</option>
                <option value="-lastName" <%= query.sort === '-lastName' ? 'selected' : '' %>>Name Z-A</option>
              </select>
            </div>
            <div class="form-group filter-actions">
              <label class="form-label">&nbsp;</label>
              <div class="btn-group">
                <button type="submit" class="btn btn-primary">Filter</button>
                <a href="/admin/users" class="btn btn-ghost">Reset</a>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Results Summary -->
    <div class="results-summary">
      <p>Showing <strong><%= users.length %></strong> of <strong><%= totalUsers %></strong> users</p>
    </div>

    <!-- Users Table -->
    <div class="card">
      <div class="card-body p-0">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>
                <input type="checkbox" id="selectAll" class="form-checkbox">
              </th>
              <th>User</th>
              <th>Email</th>
              <th>Role</th>
              <th>Status</th>
              <th>Sessions</th>
              <th>Joined</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% if (users && users.length > 0) { %>
              <% users.forEach(u => { %>
                <tr>
                  <td>
                    <input type="checkbox" class="form-checkbox user-select" value="<%= u._id %>">
                  </td>
                  <td>
                    <div class="user-cell">
                      <div class="avatar avatar-sm">
                        <% if (u.avatar) { %>
                          <img src="<%= u.avatar %>" alt="<%= u.firstName %>">
                        <% } else { %>
                          <span><%= u.firstName.charAt(0) %><%= u.lastName.charAt(0) %></span>
                        <% } %>
                      </div>
                      <div>
                        <a href="/admin/users/<%= u._id %>" class="user-name"><%= u.firstName %> <%= u.lastName %></a>
                        <span class="user-username">@<%= u.username %></span>
                      </div>
                    </div>
                  </td>
                  <td><%= u.email %></td>
                  <td>
                    <span class="badge badge-<%= u.role === 'tutor' ? 'primary' : u.role === 'admin' ? 'warning' : 'secondary' %>">
                      <%= u.role %>
                    </span>
                  </td>
                  <td>
                    <span class="badge badge-<%= u.status === 'active' ? 'success' : u.status === 'suspended' ? 'error' : 'secondary' %>">
                      <%= u.status || 'active' %>
                    </span>
                  </td>
                  <td><%= u.sessionCount || 0 %></td>
                  <td><%= new Date(u.createdAt).toLocaleDateString() %></td>
                  <td>
                    <div class="action-menu">
                      <button class="btn btn-ghost btn-sm action-trigger">‚ãÆ</button>
                      <div class="action-dropdown">
                        <a href="/admin/users/<%= u._id %>" class="action-item">
                          <span>üëÅ</span> View
                        </a>
                        <a href="/admin/users/<%= u._id %>/edit" class="action-item">
                          <span>‚úèÔ∏è</span> Edit
                        </a>
                        <a href="/profile/<%= u.username %>" class="action-item" target="_blank">
                          <span>üîó</span> Public Profile
                        </a>
                        <hr class="action-divider">
                        <% if (u.status !== 'suspended') { %>
                          <form action="/admin/users/<%= u._id %>/suspend" method="POST" class="action-form">
                            <button type="submit" class="action-item text-warning" onclick="return confirm('Suspend this user?')">
                              <span>‚ö†Ô∏è</span> Suspend
                            </button>
                          </form>
                        <% } else { %>
                          <form action="/admin/users/<%= u._id %>/activate" method="POST" class="action-form">
                            <button type="submit" class="action-item text-success">
                              <span>‚úì</span> Activate
                            </button>
                          </form>
                        <% } %>
                        <form action="/admin/users/<%= u._id %>/delete" method="POST" class="action-form">
                          <button type="submit" class="action-item text-error" onclick="return confirm('Delete this user? This cannot be undone.')">
                            <span>üóë</span> Delete
                          </button>
                        </form>
                      </div>
                    </div>
                  </td>
                </tr>
              <% }); %>
            <% } else { %>
              <tr>
                <td colspan="8">
                  <div class="empty-state">
                    <span class="empty-icon">üë•</span>
                    <h3>No users found</h3>
                    <p>Try adjusting your filters or search terms</p>
                  </div>
                </td>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Bulk Actions -->
    <div class="bulk-actions" id="bulkActions" style="display: none;">
      <span class="bulk-count"><span id="selectedCount">0</span> selected</span>
      <div class="bulk-buttons">
        <button class="btn btn-outline btn-sm" onclick="bulkAction('activate')">Activate</button>
        <button class="btn btn-outline btn-sm" onclick="bulkAction('suspend')">Suspend</button>
        <button class="btn btn-outline btn-sm text-error" onclick="bulkAction('delete')">Delete</button>
      </div>
    </div>

    <!-- Pagination -->
    <% if (totalPages > 1) { %>
      <nav class="pagination-nav">
        <a href="?page=<%= Math.max(1, currentPage - 1) %>&<%= queryString %>" 
           class="pagination-btn <%= currentPage === 1 ? 'disabled' : '' %>">
          ‚Üê Previous
        </a>
        
        <div class="pagination-pages">
          <% for (let i = 1; i <= totalPages; i++) { %>
            <% if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) { %>
              <a href="?page=<%= i %>&<%= queryString %>" 
                 class="pagination-page <%= i === currentPage ? 'active' : '' %>">
                <%= i %>
              </a>
            <% } else if (i === currentPage - 3 || i === currentPage + 3) { %>
              <span class="pagination-ellipsis">...</span>
            <% } %>
          <% } %>
        </div>
        
        <a href="?page=<%= Math.min(totalPages, currentPage + 1) %>&<%= queryString %>" 
           class="pagination-btn <%= currentPage === totalPages ? 'disabled' : '' %>">
          Next ‚Üí
        </a>
      </nav>
    <% } %>
  </main>
</div>

<style>
  .filter-form .filter-row {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr auto;
    gap: 1rem;
    align-items: end;
  }
  
  @media (max-width: 1024px) {
    .filter-form .filter-row {
      grid-template-columns: 1fr 1fr;
    }
    
    .filter-actions {
      grid-column: span 2;
    }
  }
  
  @media (max-width: 640px) {
    .filter-form .filter-row {
      grid-template-columns: 1fr;
    }
    
    .filter-actions {
      grid-column: span 1;
    }
  }
  
  .user-cell {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  
  .user-name {
    font-weight: 500;
    color: var(--neutral-800);
    text-decoration: none;
  }
  
  .user-name:hover {
    color: var(--primary-600);
  }
  
  .user-username {
    display: block;
    font-size: var(--text-sm);
    color: var(--neutral-500);
  }
  
  .results-summary {
    margin-bottom: 1rem;
    font-size: var(--text-sm);
    color: var(--neutral-600);
  }
  
  .action-menu {
    position: relative;
  }
  
  .action-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    min-width: 160px;
    background: white;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--neutral-200);
    z-index: 50;
    display: none;
    padding: 0.5rem 0;
  }
  
  .action-menu:hover .action-dropdown,
  .action-menu:focus-within .action-dropdown {
    display: block;
  }
  
  .action-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    font-size: var(--text-sm);
    color: var(--neutral-700);
    text-decoration: none;
    transition: var(--transition-fast);
    background: none;
    border: none;
    width: 100%;
    text-align: left;
    cursor: pointer;
  }
  
  .action-item:hover {
    background: var(--neutral-50);
  }
  
  .action-divider {
    margin: 0.5rem 0;
    border: none;
    border-top: 1px solid var(--neutral-200);
  }
  
  .action-form {
    margin: 0;
  }
  
  .bulk-actions {
    position: fixed;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%);
    background: var(--neutral-800);
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    gap: 1.5rem;
    box-shadow: var(--shadow-xl);
    z-index: 100;
  }
  
  .bulk-count {
    font-weight: 500;
  }
  
  .bulk-buttons {
    display: flex;
    gap: 0.5rem;
  }
</style>

<script>
  // Select all functionality
  document.getElementById('selectAll')?.addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.user-select');
    checkboxes.forEach(cb => cb.checked = this.checked);
    updateBulkActions();
  });
  
  document.querySelectorAll('.user-select').forEach(cb => {
    cb.addEventListener('change', updateBulkActions);
  });
  
  function updateBulkActions() {
    const selected = document.querySelectorAll('.user-select:checked');
    const bulkActions = document.getElementById('bulkActions');
    const selectedCount = document.getElementById('selectedCount');
    
    if (selected.length > 0) {
      bulkActions.style.display = 'flex';
      selectedCount.textContent = selected.length;
    } else {
      bulkActions.style.display = 'none';
    }
  }
  
  function bulkAction(action) {
    const selected = Array.from(document.querySelectorAll('.user-select:checked')).map(cb => cb.value);
    if (selected.length === 0) return;
    
    const confirmMsg = action === 'delete' 
      ? `Delete ${selected.length} users? This cannot be undone.`
      : `${action.charAt(0).toUpperCase() + action.slice(1)} ${selected.length} users?`;
    
    if (confirm(confirmMsg)) {
      fetch('/admin/users/bulk', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action, userIds: selected })
      }).then(() => location.reload());
    }
  }
</script>
