<%# New Review - Write a review for a completed session %>

<div class="container py-6">
  <div class="review-form-container">
    <header class="form-header">
      <a href="/reviews" class="back-link">← Back to Reviews</a>
      <h1>Write a Review</h1>
    </header>

    <div class="card">
      <div class="card-body">
        <!-- Session Info -->
        <div class="session-info-card mb-6">
          <div class="session-user">
            <div class="avatar avatar-lg">
              <% if (reviewee?.avatar) { %>
                <img src="<%= reviewee.avatar %>" alt="">
              <% } else { %>
                <span><%= reviewee?.firstName?.charAt(0) || '?' %></span>
              <% } %>
            </div>
            <div>
              <h3><%= reviewee?.firstName %> <%= reviewee?.lastName %></h3>
              <p class="text-muted">@<%= reviewee?.username %></p>
            </div>
          </div>
          <div class="session-details">
            <div class="detail">
              <span class="label">Skill</span>
              <span class="skill-tag"><%= session.skill %></span>
            </div>
            <div class="detail">
              <span class="label">Date</span>
              <span><%= new Date(session.scheduledDate).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' }) %></span>
            </div>
            <div class="detail">
              <span class="label">Duration</span>
              <span><%= session.duration || 60 %> minutes</span>
            </div>
          </div>
        </div>

        <!-- Review Form -->
        <form action="/reviews" method="POST" class="review-form">
          <input type="hidden" name="sessionId" value="<%= session._id %>">
          <input type="hidden" name="revieweeId" value="<%= reviewee._id %>">

          <!-- Rating -->
          <div class="form-group">
            <label class="form-label">Overall Rating <span class="required">*</span></label>
            <div class="rating-input" id="ratingInput">
              <% for (let i = 1; i <= 5; i++) { %>
                <button type="button" class="rating-star" data-rating="<%= i %>" aria-label="Rate <%= i %> stars">
                  <span class="star">★</span>
                </button>
              <% } %>
              <input type="hidden" name="rating" id="ratingValue" required>
            </div>
            <p class="rating-label" id="ratingLabel">Select a rating</p>
          </div>

          <!-- Comment -->
          <div class="form-group">
            <label class="form-label">Your Review <span class="required">*</span></label>
            <textarea name="comment" class="form-textarea" rows="5" 
                      placeholder="Share your experience with this tutoring session. What went well? What could be improved?"
                      minlength="20" maxlength="1000" required></textarea>
            <div class="form-hint">
              <span class="char-count">0</span> / 1000 characters (minimum 20)
            </div>
          </div>

          <!-- Category Ratings (Optional) -->
          <div class="category-ratings">
            <h4>Rate specific areas (optional)</h4>
            
            <div class="category-grid">
              <div class="category-item">
                <label>Knowledge</label>
                <div class="mini-rating" data-field="knowledgeRating">
                  <% for (let i = 1; i <= 5; i++) { %>
                    <button type="button" class="mini-star" data-rating="<%= i %>">★</button>
                  <% } %>
                  <input type="hidden" name="knowledgeRating">
                </div>
              </div>
              
              <div class="category-item">
                <label>Communication</label>
                <div class="mini-rating" data-field="communicationRating">
                  <% for (let i = 1; i <= 5; i++) { %>
                    <button type="button" class="mini-star" data-rating="<%= i %>">★</button>
                  <% } %>
                  <input type="hidden" name="communicationRating">
                </div>
              </div>
              
              <div class="category-item">
                <label>Punctuality</label>
                <div class="mini-rating" data-field="punctualityRating">
                  <% for (let i = 1; i <= 5; i++) { %>
                    <button type="button" class="mini-star" data-rating="<%= i %>">★</button>
                  <% } %>
                  <input type="hidden" name="punctualityRating">
                </div>
              </div>
              
              <div class="category-item">
                <label>Helpfulness</label>
                <div class="mini-rating" data-field="helpfulnessRating">
                  <% for (let i = 1; i <= 5; i++) { %>
                    <button type="button" class="mini-star" data-rating="<%= i %>">★</button>
                  <% } %>
                  <input type="hidden" name="helpfulnessRating">
                </div>
              </div>
            </div>
          </div>

          <!-- Would Recommend -->
          <div class="form-group">
            <label class="form-checkbox-label">
              <input type="checkbox" name="wouldRecommend" class="form-checkbox" checked>
              <span>I would recommend <%= reviewee?.firstName %> to other students</span>
            </label>
          </div>

          <!-- Submit -->
          <div class="form-actions">
            <a href="/reviews" class="btn btn-ghost">Cancel</a>
            <button type="submit" class="btn btn-primary">Submit Review</button>
          </div>
        </form>
      </div>
    </div>

    <div class="review-guidelines mt-4">
      <h4>Review Guidelines</h4>
      <ul>
        <li>Be honest and constructive in your feedback</li>
        <li>Focus on the tutoring experience, not personal matters</li>
        <li>Avoid using inappropriate language</li>
        <li>Reviews cannot be edited after 24 hours</li>
      </ul>
    </div>
  </div>
</div>

<style>
  .review-form-container {
    max-width: 640px;
    margin: 0 auto;
  }
  
  .form-header {
    margin-bottom: 1.5rem;
  }
  
  .back-link {
    display: inline-block;
    margin-bottom: 0.5rem;
    color: var(--neutral-600);
    text-decoration: none;
    font-size: var(--text-sm);
  }
  
  .back-link:hover {
    color: var(--primary-600);
  }
  
  .form-header h1 {
    margin: 0;
  }
  
  .session-info-card {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    padding: 1.5rem;
    background: var(--neutral-50);
    border-radius: var(--radius-lg);
  }
  
  @media (min-width: 640px) {
    .session-info-card {
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
    }
  }
  
  .session-user {
    display: flex;
    align-items: center;
    gap: 1rem;
  }
  
  .session-user h3 {
    margin: 0;
    font-size: var(--text-lg);
  }
  
  .session-details {
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
  }
  
  .session-details .detail {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }
  
  .session-details .label {
    font-size: var(--text-xs);
    color: var(--neutral-500);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  
  /* Rating Input */
  .rating-input {
    display: flex;
    gap: 0.5rem;
  }
  
  .rating-star {
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    font-size: 2.5rem;
    color: var(--neutral-300);
    transition: var(--transition-fast);
  }
  
  .rating-star:hover,
  .rating-star.active {
    color: var(--warning-400);
    transform: scale(1.1);
  }
  
  .rating-star:hover ~ .rating-star {
    color: var(--neutral-300);
  }
  
  .rating-label {
    margin-top: 0.5rem;
    font-size: var(--text-sm);
    color: var(--neutral-600);
  }
  
  /* Category Ratings */
  .category-ratings {
    margin: 2rem 0;
    padding: 1.5rem;
    background: var(--neutral-50);
    border-radius: var(--radius-lg);
  }
  
  .category-ratings h4 {
    margin: 0 0 1rem 0;
    font-size: var(--text-sm);
    color: var(--neutral-600);
  }
  
  .category-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
  }
  
  @media (max-width: 480px) {
    .category-grid {
      grid-template-columns: 1fr;
    }
  }
  
  .category-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .category-item label {
    font-size: var(--text-sm);
    color: var(--neutral-700);
  }
  
  .mini-rating {
    display: flex;
    gap: 0.125rem;
  }
  
  .mini-star {
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    font-size: 1.25rem;
    color: var(--neutral-300);
    transition: var(--transition-fast);
  }
  
  .mini-star:hover,
  .mini-star.active {
    color: var(--warning-400);
  }
  
  .form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--neutral-200);
  }
  
  .review-guidelines {
    padding: 1.25rem;
    background: var(--neutral-50);
    border-radius: var(--radius-lg);
  }
  
  .review-guidelines h4 {
    margin: 0 0 0.75rem 0;
    font-size: var(--text-sm);
    color: var(--neutral-600);
  }
  
  .review-guidelines ul {
    margin: 0;
    padding-left: 1.25rem;
    font-size: var(--text-sm);
    color: var(--neutral-600);
  }
  
  .review-guidelines li {
    margin-bottom: 0.25rem;
  }
</style>

<script>
  // Main rating input
  const ratingLabels = ['', 'Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
  const ratingInput = document.getElementById('ratingInput');
  const ratingValue = document.getElementById('ratingValue');
  const ratingLabel = document.getElementById('ratingLabel');
  
  ratingInput.querySelectorAll('.rating-star').forEach(star => {
    star.addEventListener('click', () => {
      const rating = parseInt(star.dataset.rating);
      ratingValue.value = rating;
      ratingLabel.textContent = ratingLabels[rating];
      
      ratingInput.querySelectorAll('.rating-star').forEach((s, i) => {
        s.classList.toggle('active', i < rating);
      });
    });
    
    star.addEventListener('mouseenter', () => {
      const rating = parseInt(star.dataset.rating);
      ratingInput.querySelectorAll('.rating-star').forEach((s, i) => {
        s.style.color = i < rating ? 'var(--warning-400)' : 'var(--neutral-300)';
      });
    });
  });
  
  ratingInput.addEventListener('mouseleave', () => {
    const current = parseInt(ratingValue.value) || 0;
    ratingInput.querySelectorAll('.rating-star').forEach((s, i) => {
      s.style.color = '';
      s.classList.toggle('active', i < current);
    });
  });
  
  // Mini ratings
  document.querySelectorAll('.mini-rating').forEach(container => {
    const input = container.querySelector('input[type="hidden"]');
    container.querySelectorAll('.mini-star').forEach(star => {
      star.addEventListener('click', () => {
        const rating = parseInt(star.dataset.rating);
        input.value = rating;
        container.querySelectorAll('.mini-star').forEach((s, i) => {
          s.classList.toggle('active', i < rating);
        });
      });
    });
  });
  
  // Character counter
  const textarea = document.querySelector('textarea[name="comment"]');
  const charCount = document.querySelector('.char-count');
  
  textarea.addEventListener('input', () => {
    const count = textarea.value.length;
    charCount.textContent = count;
    charCount.style.color = count < 20 ? 'var(--error-500)' : count > 900 ? 'var(--warning-500)' : '';
  });
</script>
