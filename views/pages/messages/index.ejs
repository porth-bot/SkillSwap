<%# Messages - Conversation List %>

<div class="messages-layout">
  <!-- Conversations Sidebar -->
  <aside class="conversations-sidebar">
    <div class="conversations-header">
      <h2>Messages</h2>
      <button class="btn btn-ghost btn-sm" id="newMessageBtn" title="New Message">
        <span>‚úèÔ∏è</span>
      </button>
    </div>
    
    <div class="conversations-search">
      <input type="text" class="form-input" placeholder="Search conversations..." id="conversationSearch">
    </div>
    
    <div class="conversations-list" id="conversationsList">
      <% if (conversations && conversations.length > 0) { %>
        <% conversations.forEach(conv => { %>
          <a href="/messages/<%= conv._id %>" class="conversation-item <%= conv._id.toString() === activeConversation ? 'active' : '' %> <%= conv.unreadCount > 0 ? 'unread' : '' %>">
            <div class="avatar">
              <% const otherUser = conv.participants.find(p => p._id.toString() !== user._id.toString()); %>
              <% if (otherUser?.avatar) { %>
                <img src="<%= otherUser.avatar %>" alt="">
              <% } else { %>
                <span><%= otherUser?.firstName?.charAt(0) || '?' %></span>
              <% } %>
              <% if (otherUser?.isOnline) { %>
                <span class="online-indicator"></span>
              <% } %>
            </div>
            <div class="conversation-content">
              <div class="conversation-header">
                <span class="conversation-name"><%= otherUser?.firstName %> <%= otherUser?.lastName %></span>
                <span class="conversation-time"><%= conv.lastMessageTime %></span>
              </div>
              <div class="conversation-preview">
                <p><%= conv.lastMessage?.substring(0, 40) %><%= conv.lastMessage?.length > 40 ? '...' : '' %></p>
                <% if (conv.unreadCount > 0) { %>
                  <span class="unread-badge"><%= conv.unreadCount %></span>
                <% } %>
              </div>
            </div>
          </a>
        <% }); %>
      <% } else { %>
        <div class="empty-conversations">
          <span class="empty-icon">üí¨</span>
          <p>No conversations yet</p>
          <p class="text-sm text-muted">Start a conversation with a tutor or student</p>
        </div>
      <% } %>
    </div>
  </aside>

  <!-- Chat Area -->
  <main class="chat-area">
    <% if (activeConversation && currentChat) { %>
      <!-- Chat Header -->
      <header class="chat-header">
        <div class="chat-user">
          <div class="avatar">
            <% const chatPartner = currentChat.participants.find(p => p._id.toString() !== user._id.toString()); %>
            <% if (chatPartner?.avatar) { %>
              <img src="<%= chatPartner.avatar %>" alt="">
            <% } else { %>
              <span><%= chatPartner?.firstName?.charAt(0) || '?' %></span>
            <% } %>
          </div>
          <div class="chat-user-info">
            <h3><%= chatPartner?.firstName %> <%= chatPartner?.lastName %></h3>
            <span class="user-status <%= chatPartner?.isOnline ? 'online' : '' %>">
              <%= chatPartner?.isOnline ? 'Online' : 'Offline' %>
            </span>
          </div>
        </div>
        <div class="chat-actions">
          <a href="/profile/<%= chatPartner?.username %>" class="btn btn-ghost btn-sm" title="View Profile">
            <span>üë§</span>
          </a>
          <button class="btn btn-ghost btn-sm" title="More Options">
            <span>‚ãÆ</span>
          </button>
        </div>
      </header>

      <!-- Messages -->
      <div class="chat-messages" id="chatMessages">
        <% if (currentChat.messages && currentChat.messages.length > 0) { %>
          <% let lastDate = null; %>
          <% currentChat.messages.forEach(msg => { %>
            <% 
              const msgDate = new Date(msg.createdAt).toDateString();
              const showDateDivider = lastDate !== msgDate;
              lastDate = msgDate;
            %>
            <% if (showDateDivider) { %>
              <div class="date-divider">
                <span><%= new Date(msg.createdAt).toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' }) %></span>
              </div>
            <% } %>
            <div class="message <%= msg.sender.toString() === user._id.toString() ? 'sent' : 'received' %>">
              <div class="message-content">
                <p><%= msg.content %></p>
                <span class="message-time"><%= new Date(msg.createdAt).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) %></span>
              </div>
            </div>
          <% }); %>
        <% } else { %>
          <div class="empty-chat">
            <p>No messages yet. Start the conversation!</p>
          </div>
        <% } %>
      </div>

      <!-- Message Input -->
      <form class="chat-input" action="/messages/<%= activeConversation %>" method="POST" id="messageForm">
        <input type="text" name="message" class="form-input" placeholder="Type a message..." autocomplete="off" required id="messageInput">
        <button type="submit" class="btn btn-primary">
          <span>Send</span>
        </button>
      </form>
    <% } else { %>
      <!-- No Chat Selected -->
      <div class="no-chat-selected">
        <div class="empty-state">
          <span class="empty-icon">üí¨</span>
          <h3>Select a conversation</h3>
          <p>Choose a conversation from the sidebar or start a new one</p>
        </div>
      </div>
    <% } %>
  </main>
</div>

<!-- New Message Modal -->
<div class="modal" id="newMessageModal">
  <div class="modal-overlay"></div>
  <div class="modal-container">
    <div class="modal-header">
      <h3>New Message</h3>
      <button class="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <form action="/messages/new" method="POST" id="newMessageForm">
        <div class="form-group">
          <label class="form-label">To:</label>
          <input type="text" name="recipient" class="form-input" placeholder="Search for a user..." id="recipientSearch" autocomplete="off">
          <input type="hidden" name="recipientId" id="recipientId">
          <div class="search-results" id="recipientResults"></div>
        </div>
        <div class="form-group">
          <label class="form-label">Message:</label>
          <textarea name="message" class="form-textarea" rows="3" placeholder="Write your message..." required></textarea>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-ghost modal-close">Cancel</button>
          <button type="submit" class="btn btn-primary">Send Message</button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
  .messages-layout {
    display: grid;
    grid-template-columns: 320px 1fr;
    height: calc(100vh - 64px);
    background: var(--neutral-50);
  }
  
  @media (max-width: 768px) {
    .messages-layout {
      grid-template-columns: 1fr;
    }
    
    .conversations-sidebar {
      display: <%= activeConversation ? 'none' : 'flex' %>;
    }
    
    .chat-area {
      display: <%= activeConversation ? 'flex' : 'none' %>;
    }
  }
  
  /* Conversations Sidebar */
  .conversations-sidebar {
    display: flex;
    flex-direction: column;
    background: white;
    border-right: 1px solid var(--neutral-200);
  }
  
  .conversations-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--neutral-100);
  }
  
  .conversations-header h2 {
    font-size: var(--text-lg);
    font-weight: 600;
  }
  
  .conversations-search {
    padding: 0.75rem 1rem;
  }
  
  .conversations-list {
    flex: 1;
    overflow-y: auto;
  }
  
  .conversation-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.875rem 1rem;
    text-decoration: none;
    color: inherit;
    border-bottom: 1px solid var(--neutral-100);
    transition: var(--transition-fast);
  }
  
  .conversation-item:hover {
    background: var(--neutral-50);
  }
  
  .conversation-item.active {
    background: var(--primary-50);
    border-left: 3px solid var(--primary-500);
  }
  
  .conversation-item.unread {
    background: var(--primary-50);
  }
  
  .conversation-item .avatar {
    position: relative;
  }
  
  .online-indicator {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 10px;
    height: 10px;
    background: var(--success-500);
    border: 2px solid white;
    border-radius: 50%;
  }
  
  .conversation-content {
    flex: 1;
    min-width: 0;
  }
  
  .conversation-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 0.25rem;
  }
  
  .conversation-name {
    font-weight: 500;
    color: var(--neutral-800);
  }
  
  .conversation-time {
    font-size: var(--text-xs);
    color: var(--neutral-500);
  }
  
  .conversation-preview {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .conversation-preview p {
    font-size: var(--text-sm);
    color: var(--neutral-600);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin: 0;
  }
  
  .unread-badge {
    background: var(--primary-500);
    color: white;
    font-size: var(--text-xs);
    font-weight: 600;
    padding: 0.125rem 0.375rem;
    border-radius: var(--radius-full);
    min-width: 18px;
    text-align: center;
  }
  
  .empty-conversations {
    padding: 2rem;
    text-align: center;
    color: var(--neutral-500);
  }
  
  /* Chat Area */
  .chat-area {
    display: flex;
    flex-direction: column;
    background: white;
  }
  
  .chat-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--neutral-200);
    background: white;
  }
  
  .chat-user {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  
  .chat-user-info h3 {
    font-size: var(--text-base);
    font-weight: 600;
    margin: 0;
  }
  
  .user-status {
    font-size: var(--text-sm);
    color: var(--neutral-500);
  }
  
  .user-status.online {
    color: var(--success-600);
  }
  
  .chat-actions {
    display: flex;
    gap: 0.5rem;
  }
  
  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    background: var(--neutral-50);
  }
  
  .date-divider {
    text-align: center;
    margin: 1rem 0;
  }
  
  .date-divider span {
    background: var(--neutral-100);
    padding: 0.25rem 0.75rem;
    border-radius: var(--radius-full);
    font-size: var(--text-xs);
    color: var(--neutral-500);
  }
  
  .message {
    display: flex;
    max-width: 70%;
  }
  
  .message.sent {
    align-self: flex-end;
  }
  
  .message.received {
    align-self: flex-start;
  }
  
  .message-content {
    padding: 0.75rem 1rem;
    border-radius: var(--radius-lg);
  }
  
  .message.sent .message-content {
    background: var(--primary-500);
    color: white;
    border-bottom-right-radius: var(--radius-sm);
  }
  
  .message.received .message-content {
    background: white;
    border: 1px solid var(--neutral-200);
    border-bottom-left-radius: var(--radius-sm);
  }
  
  .message-content p {
    margin: 0 0 0.25rem 0;
    line-height: 1.4;
  }
  
  .message-time {
    font-size: var(--text-xs);
    opacity: 0.7;
  }
  
  .empty-chat {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--neutral-500);
  }
  
  .chat-input {
    display: flex;
    gap: 0.75rem;
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--neutral-200);
    background: white;
  }
  
  .chat-input .form-input {
    flex: 1;
  }
  
  .no-chat-selected {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  /* Search Results */
  .search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid var(--neutral-200);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-lg);
    max-height: 200px;
    overflow-y: auto;
    display: none;
    z-index: 100;
  }
  
  .search-results.show {
    display: block;
  }
  
  .search-result-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    cursor: pointer;
    transition: var(--transition-fast);
  }
  
  .search-result-item:hover {
    background: var(--neutral-50);
  }
</style>

<script>
  // Scroll to bottom of messages
  const chatMessages = document.getElementById('chatMessages');
  if (chatMessages) {
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }
  
  // New message modal
  const newMessageBtn = document.getElementById('newMessageBtn');
  const newMessageModal = document.getElementById('newMessageModal');
  
  if (newMessageBtn && newMessageModal) {
    newMessageBtn.addEventListener('click', () => {
      newMessageModal.classList.add('show');
    });
  }
  
  // Conversation search
  const conversationSearch = document.getElementById('conversationSearch');
  if (conversationSearch) {
    conversationSearch.addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase();
      document.querySelectorAll('.conversation-item').forEach(item => {
        const name = item.querySelector('.conversation-name').textContent.toLowerCase();
        item.style.display = name.includes(query) ? 'flex' : 'none';
      });
    });
  }
  
  // Auto-submit message form with Enter
  const messageInput = document.getElementById('messageInput');
  if (messageInput) {
    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('messageForm').submit();
      }
    });
  }
</script>
