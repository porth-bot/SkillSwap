<%# Sessions - List all sessions for the user %>

<div class="sessions-container">
  <div class="sessions-header">
    <div class="header-content">
      <h1>My Sessions</h1>
      <p class="text-muted">Manage your tutoring sessions</p>
    </div>
    <div class="header-actions">
      <a href="/explore" class="btn btn-primary">
        <i data-lucide="plus"></i>
        Book New Session
      </a>
    </div>
  </div>

  <!-- Status Tabs -->
  <div class="sessions-tabs">
    <a href="/sessions" class="tab <%= !status || status === 'all' ? 'active' : '' %>">
      All
      <span class="tab-count"><%= counts.all || 0 %></span>
    </a>
    <a href="/sessions?status=upcoming" class="tab <%= status === 'upcoming' ? 'active' : '' %>">
      Upcoming
      <span class="tab-count"><%= counts.upcoming || 0 %></span>
    </a>
    <a href="/sessions?status=pending" class="tab <%= status === 'pending' ? 'active' : '' %>">
      Pending
      <% if (counts.pending > 0) { %>
        <span class="tab-count tab-count-warning"><%= counts.pending %></span>
      <% } else { %>
        <span class="tab-count"><%= counts.pending || 0 %></span>
      <% } %>
    </a>
    <a href="/sessions?status=completed" class="tab <%= status === 'completed' ? 'active' : '' %>">
      Completed
      <span class="tab-count"><%= counts.completed || 0 %></span>
    </a>
    <a href="/sessions?status=cancelled" class="tab <%= status === 'cancelled' ? 'active' : '' %>">
      Cancelled
      <span class="tab-count"><%= counts.cancelled || 0 %></span>
    </a>
  </div>

  <!-- Sessions List -->
  <div class="sessions-list">
    <% if (sessions && sessions.length > 0) { %>
      <% sessions.forEach(session => { %>
        <div class="session-card">
          <div class="session-date-badge">
            <span class="date-day"><%= new Date(session.scheduledDate).getDate() %></span>
            <span class="date-month"><%= new Date(session.scheduledDate).toLocaleDateString('en-US', { month: 'short' }) %></span>
            <span class="date-year"><%= new Date(session.scheduledDate).getFullYear() %></span>
          </div>
          
          <div class="session-main">
            <div class="session-info">
              <h3 class="session-skill"><%= session.skill %></h3>
              <div class="session-participants">
                <% if (session.tutor._id.toString() === user._id.toString()) { %>
                  <span class="role-label">Student:</span>
                  <a href="/profile/<%= session.student.username %>" class="participant">
                    <div class="avatar avatar-xs">
                      <% if (session.student.avatar) { %>
                        <img src="<%= session.student.avatar %>" alt="<%= session.student.firstName %>">
                      <% } else { %>
                        <span><%= session.student.firstName.charAt(0) %></span>
                      <% } %>
                    </div>
                    <%= session.student.firstName %> <%= session.student.lastName %>
                  </a>
                <% } else { %>
                  <span class="role-label">Tutor:</span>
                  <a href="/profile/<%= session.tutor.username %>" class="participant">
                    <div class="avatar avatar-xs">
                      <% if (session.tutor.avatar) { %>
                        <img src="<%= session.tutor.avatar %>" alt="<%= session.tutor.firstName %>">
                      <% } else { %>
                        <span><%= session.tutor.firstName.charAt(0) %></span>
                      <% } %>
                    </div>
                    <%= session.tutor.firstName %> <%= session.tutor.lastName %>
                  </a>
                <% } %>
              </div>
              <div class="session-time">
                <i data-lucide="clock" class="icon-sm"></i>
                <%= session.startTime %> - <%= session.endTime %>
                <span class="duration">(<%= session.duration %> min)</span>
              </div>
            </div>
            
            <div class="session-status-col">
              <span class="badge badge-<%= 
                session.status === 'confirmed' ? 'success' : 
                session.status === 'pending' ? 'warning' : 
                session.status === 'completed' ? 'info' : 
                session.status === 'cancelled' ? 'danger' : 'neutral' 
              %>">
                <%= session.status.charAt(0).toUpperCase() + session.status.slice(1) %>
              </span>
              
              <% if (session.location) { %>
                <div class="session-location text-sm text-muted">
                  <i data-lucide="<%= session.location.type === 'online' ? 'video' : 'map-pin' %>" class="icon-xs"></i>
                  <%= session.location.type === 'online' ? 'Online' : session.location.details %>
                </div>
              <% } %>
            </div>
          </div>
          
          <div class="session-actions">
            <a href="/sessions/<%= session._id %>" class="btn btn-sm btn-outline">View Details</a>
            
            <% if (session.status === 'pending' && session.tutor._id.toString() === user._id.toString()) { %>
              <form action="/sessions/<%= session._id %>/respond" method="POST" class="inline-form">
                <input type="hidden" name="action" value="accept">
                <button type="submit" class="btn btn-sm btn-success">Accept</button>
              </form>
              <form action="/sessions/<%= session._id %>/respond" method="POST" class="inline-form">
                <input type="hidden" name="action" value="decline">
                <button type="submit" class="btn btn-sm btn-ghost text-danger">Decline</button>
              </form>
            <% } %>
            
            <% if (session.status === 'confirmed') { %>
              <a href="/messages/<%= session.tutor._id.toString() === user._id.toString() ? session.student._id : session.tutor._id %>" class="btn btn-sm btn-ghost">
                <i data-lucide="message-square" class="icon-sm"></i>
              </a>
              
              <% 
                const sessionDate = new Date(session.scheduledDate);
                const now = new Date();
                const hoursDiff = (sessionDate - now) / (1000 * 60 * 60);
              %>
              <% if (hoursDiff > 24) { %>
                <button type="button" class="btn btn-sm btn-ghost text-danger" onclick="confirmCancel('<%= session._id %>')">
                  Cancel
                </button>
              <% } %>
            <% } %>
            
            <% if (session.status === 'completed' && !session.hasReviewed) { %>
              <% if (session.student._id.toString() === user._id.toString()) { %>
                <a href="/reviews/create/<%= session._id %>" class="btn btn-sm btn-primary">
                  <i data-lucide="star" class="icon-sm"></i>
                  Leave Review
                </a>
              <% } %>
            <% } %>
          </div>
        </div>
      <% }) %>
      
      <!-- Pagination -->
      <% if (pagination && pagination.totalPages > 1) { %>
        <div class="pagination-container">
          <nav class="pagination">
            <% if (pagination.hasPrev) { %>
              <a href="/sessions?status=<%= status || '' %>&page=<%= pagination.currentPage - 1 %>" class="pagination-btn">
                <i data-lucide="chevron-left"></i>
              </a>
            <% } %>
            
            <span class="pagination-info">
              Page <%= pagination.currentPage %> of <%= pagination.totalPages %>
            </span>
            
            <% if (pagination.hasNext) { %>
              <a href="/sessions?status=<%= status || '' %>&page=<%= pagination.currentPage + 1 %>" class="pagination-btn">
                <i data-lucide="chevron-right"></i>
              </a>
            <% } %>
          </nav>
        </div>
      <% } %>
    <% } else { %>
      <div class="empty-state">
        <div class="empty-icon">
          <i data-lucide="calendar"></i>
        </div>
        <h3>No sessions found</h3>
        <p class="text-muted">
          <% if (status === 'pending') { %>
            You don't have any pending session requests
          <% } else if (status === 'upcoming') { %>
            You don't have any upcoming sessions scheduled
          <% } else if (status === 'completed') { %>
            You haven't completed any sessions yet
          <% } else if (status === 'cancelled') { %>
            No cancelled sessions
          <% } else { %>
            Start by booking a session with a tutor
          <% } %>
        </p>
        <% if (!status || status === 'all' || status === 'upcoming') { %>
          <a href="/explore" class="btn btn-primary">Find a Tutor</a>
        <% } %>
      </div>
    <% } %>
  </div>
</div>

<!-- Cancel Confirmation Modal -->
<div id="cancel-modal" class="modal">
  <div class="modal-overlay" onclick="closeModal()"></div>
  <div class="modal-content">
    <h3>Cancel Session</h3>
    <p>Are you sure you want to cancel this session? This action cannot be undone.</p>
    <form id="cancel-form" method="POST">
      <div class="form-group">
        <label for="cancel-reason">Reason for cancellation (optional)</label>
        <textarea id="cancel-reason" name="reason" rows="3" class="form-textarea" placeholder="Let them know why you're cancelling..."></textarea>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-ghost" onclick="closeModal()">Keep Session</button>
        <button type="submit" class="btn btn-danger">Cancel Session</button>
      </div>
    </form>
  </div>
</div>

<style>
  .sessions-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: var(--space-6);
  }

  .sessions-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-6);
    flex-wrap: wrap;
    gap: var(--space-4);
  }

  .sessions-header h1 {
    font-size: var(--text-3xl);
    margin-bottom: var(--space-1);
  }

  .sessions-tabs {
    display: flex;
    gap: var(--space-1);
    background: var(--neutral-100);
    padding: var(--space-1);
    border-radius: var(--radius-lg);
    margin-bottom: var(--space-6);
    overflow-x: auto;
  }

  .tab {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-4);
    border-radius: var(--radius-md);
    color: var(--neutral-600);
    text-decoration: none;
    font-weight: 500;
    white-space: nowrap;
    transition: var(--transition-base);
  }

  .tab:hover {
    color: var(--neutral-900);
    background: var(--white);
  }

  .tab.active {
    color: var(--primary-700);
    background: var(--white);
    box-shadow: var(--shadow-sm);
  }

  .tab-count {
    font-size: var(--text-xs);
    padding: var(--space-1) var(--space-2);
    background: var(--neutral-200);
    border-radius: var(--radius-full);
    color: var(--neutral-600);
  }

  .tab.active .tab-count {
    background: var(--primary-100);
    color: var(--primary-700);
  }

  .tab-count-warning {
    background: var(--warning-100) !important;
    color: var(--warning-700) !important;
  }

  .sessions-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  .session-card {
    display: flex;
    gap: var(--space-5);
    background: var(--white);
    border-radius: var(--radius-lg);
    padding: var(--space-5);
    box-shadow: var(--shadow-sm);
    transition: var(--transition-base);
  }

  .session-card:hover {
    box-shadow: var(--shadow-md);
  }

  .session-date-badge {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-width: 70px;
    padding: var(--space-3);
    background: var(--primary-50);
    border-radius: var(--radius-md);
    text-align: center;
  }

  .date-day {
    font-size: var(--text-2xl);
    font-weight: 700;
    color: var(--primary-700);
    line-height: 1;
  }

  .date-month {
    font-size: var(--text-sm);
    font-weight: 500;
    color: var(--primary-600);
    text-transform: uppercase;
  }

  .date-year {
    font-size: var(--text-xs);
    color: var(--primary-500);
  }

  .session-main {
    flex: 1;
    display: flex;
    gap: var(--space-4);
  }

  .session-info {
    flex: 1;
  }

  .session-skill {
    font-size: var(--text-lg);
    margin-bottom: var(--space-2);
  }

  .session-participants {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    margin-bottom: var(--space-2);
  }

  .role-label {
    font-size: var(--text-sm);
    color: var(--neutral-500);
  }

  .participant {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    color: var(--neutral-700);
    text-decoration: none;
    font-weight: 500;
  }

  .participant:hover {
    color: var(--primary-600);
  }

  .session-time {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    font-size: var(--text-sm);
    color: var(--neutral-600);
  }

  .duration {
    color: var(--neutral-400);
  }

  .session-status-col {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: var(--space-2);
  }

  .session-location {
    display: flex;
    align-items: center;
    gap: var(--space-1);
  }

  .session-actions {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    align-items: flex-end;
    justify-content: center;
  }

  .inline-form {
    display: inline;
  }

  .empty-state {
    text-align: center;
    padding: var(--space-16);
    background: var(--white);
    border-radius: var(--radius-lg);
  }

  .empty-icon {
    width: 80px;
    height: 80px;
    margin: 0 auto var(--space-4);
    background: var(--neutral-100);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--neutral-400);
  }

  .empty-icon i {
    width: 40px;
    height: 40px;
  }

  .empty-state h3 {
    margin-bottom: var(--space-2);
  }

  .empty-state .btn {
    margin-top: var(--space-4);
  }

  .pagination-container {
    display: flex;
    justify-content: center;
    margin-top: var(--space-6);
  }

  .pagination {
    display: flex;
    align-items: center;
    gap: var(--space-3);
  }

  .pagination-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    background: var(--white);
    border: 1px solid var(--neutral-200);
    border-radius: var(--radius-md);
    color: var(--neutral-700);
    text-decoration: none;
    transition: var(--transition-base);
  }

  .pagination-btn:hover {
    background: var(--neutral-50);
    border-color: var(--primary-300);
  }

  .pagination-info {
    font-size: var(--text-sm);
    color: var(--neutral-600);
  }

  .modal {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }

  .modal.active {
    display: flex;
  }

  .modal-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
  }

  .modal-content {
    position: relative;
    background: var(--white);
    border-radius: var(--radius-lg);
    padding: var(--space-6);
    max-width: 400px;
    width: 90%;
  }

  .modal-content h3 {
    margin-bottom: var(--space-3);
  }

  .modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: var(--space-3);
    margin-top: var(--space-4);
  }

  @media (max-width: 768px) {
    .sessions-container {
      padding: var(--space-4);
    }

    .session-card {
      flex-direction: column;
    }

    .session-date-badge {
      flex-direction: row;
      justify-content: flex-start;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3);
    }

    .date-day {
      font-size: var(--text-lg);
    }

    .session-main {
      flex-direction: column;
    }

    .session-status-col {
      flex-direction: row;
      align-items: center;
      justify-content: flex-start;
    }

    .session-actions {
      flex-direction: row;
      flex-wrap: wrap;
    }
  }
</style>

<script>
  function confirmCancel(sessionId) {
    const modal = document.getElementById('cancel-modal');
    const form = document.getElementById('cancel-form');
    form.action = `/sessions/${sessionId}/cancel`;
    modal.classList.add('active');
  }

  function closeModal() {
    const modal = document.getElementById('cancel-modal');
    modal.classList.remove('active');
  }
</script>
